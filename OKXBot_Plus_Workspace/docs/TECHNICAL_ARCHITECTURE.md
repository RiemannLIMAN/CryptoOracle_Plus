# 🏗️ 技术架构深度解析 (v3.9.6)

CryptoOracle 并非传统的“线性轮询”脚本，而是一个基于 **AsyncIO** 的**三轨异步 (Triple-Track Async)** 决策执行系统。

---

## 1. 三轨异步逻辑 (Triple-Track Architecture)

为了彻底解决“AI 思考慢”与“风控要求快”的结构性矛盾，我们将逻辑拆分为三条并行轨道：

### 轨道 A: 战略决策轨 (Strategy Orbit)
*   **频率**: 低频 (15m/1h)。
*   **核心逻辑**: 
    *   聚合 K 线、指标、情绪数据。
    *   调用 **DeepSeek-V3** 进行语义级分析。
    *   **产出**: 交易信号（Long/Short/Neutral）及 AI 建议仓位比 (`position_ratio`)。
*   **设计初衷**: AI 擅长识别“大势”，但不擅长捕捉“插针”。将 AI 放在低频轨道可以最大限度降低 Token 成本并提升信号稳定性。

### 轨道 B: 执行同步轨 (Execution Orbit)
*   **频率**: 事件驱动 (Event-Driven)。
*   **核心逻辑**: 
    *   订单生命周期管理（下单、撤单、重试）。
    *   资产余额双重审计（交易所 API + 本地状态机）。
*   **设计初衷**: 确保下单逻辑的原子性，防止在网络波动时出现“重单”或“漏单”。

### 轨道 C: 战术风控轨 (Tactical/Risk Orbit)
*   **频率**: **极高频 (10s)**。
*   **核心逻辑**: 
    *   **移动止盈 (Trailing Stop)**: 实时计算当前价格与追踪水位线的距离。
    *   **分段止盈 (Partial TP)**: 监控浮盈阶梯，触发市价平仓。
    *   **每日利润锁定**: 监控账户总额，触线后强制执行减仓逻辑。
*   **设计初衷**: **这是 v3.9.6 的灵魂。** 即使 AI 正在卡顿或 API 响应变慢，轨道 C 也会独立运行，确保您的本金在插针行情中得到毫秒级的保护。

---

## 2. 数据流与冲突处理

### 2.1 零点校准 (Zero-Start Baseline)
系统启动时，会立即拍摄一张“资产快照”存入 SQLite 数据库。
*   **解决痛点**: 解决了“因为账户原本就有持仓而导致盈亏计算混乱”的问题。
*   **实现**: 所有的盈亏计算均基于 `(当前余额 - 启动快照余额)`。

### 2.2 信号冲突逻辑
当轨道 A 生成了一个“做多”信号，但轨道 C 正因为“触发账户级回撤熔断”而处于冷却期时：
*   **优先级**: **轨道 C (风控) > 轨道 A (信号)**。
*   **处理**: 系统会记录该信号但拒绝执行，并在日志中输出 `RiskGate: Blocked by drawdown protection`。

---

## 3. 架构瘦身与性能

在 v3.9.6 中，我们移除了原有的 TensorBoard 和大型 ML 库依赖：
*   **内存占用**: 从 1.2GB 降低至 **150MB** 左右。
*   **冷启动速度**: 提升 400%。
*   **稳定性**: 减少了底层 C++ 库冲突导致的 `Segmentation Fault`。

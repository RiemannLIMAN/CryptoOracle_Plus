# ⚙️ 配置文件 (config.json) 深度指南 (v3.9.7)

> **核心原则**: 每个参数的背后都是对市场波动的数学假设。**不要只配置数字，要理解数字背后的博弈。**

---

## 🔥 热重载 (Hot Reload) 机制说明

系统支持对 `config.json` 的部分参数进行实时热重载，无需重启机器人即可生效。

### ✅ 支持热重载的参数
- **`symbols` 列表**: 
    - **新增币种**: 在列表中添加新交易对，系统会自动初始化并启动新的交易器。
    - **移除币种**: 从列表中删除交易对，系统会自动停止该币种的交易器并释放资源。
- **单个币种的 `leverage` (杠杆)**: 修改后，系统会实时调用交易所 API 同步新的杠杆设置。
- **单个币种的 `allocation` (资金分配比例)**: 修改后，下一轮下单计算将自动采用新比例。

### ❌ 不支持热重载的参数 (修改后必须重启)
- **全局交易参数 (`trading`)**: 如 `loop_interval`、`timeframe`、`test_mode` 等。
- **具体策略参数 (`strategy`)**: 如 `rsi_min` / `rsi_max`、`trailing_stop` 阈值等。
- **全局风控参数 (`risk_control`)**: 如 `max_loss_usdt`、`initial_balance_usdt` 等。
- **模型与交易所设置 (`models`, `exchanges`)**: API 地址、模型名称等。

---

## 1. 交易核心配置 (trading)

### `loop_interval` (主循环间隔)
*   **设计原理**: 这是机器人的“心跳频率”，对应架构中的 **轨道 C (Orbit C)**。
*   **知其所以然**: 为什么建议 `10` 秒？
    *   **实时风控**: 止盈止损不能等待 15 分钟 K 线结束，必须在插针发生时立即响应。
    *   **资源平衡**: 过短（如 < 1s）会导致 API 频率超限 (Rate Limit)；过长（如 > 60s）会导致止盈点位大幅滑点。
*   **建议**: 10-20s。

### `max_slippage_percent` (最大滑点限制)
*   **设计原理**: 保护成交价格不偏离预期。
*   **建议**: 主流币 0.5% - 1.0%，山寨币 1.5% - 2.5%。

### `max_concurrent_traders` (最大并发交易员)
*   **[v3.9.7 新增]**: 配合 `asyncio.Semaphore` 使用。限制同时进行网络请求的币种数量，防止因瞬时并发过高导致本地网络拥塞或 API 报错。
*   **建议**: 4-8。

---

## 2. 策略深度配置 (strategy)

### `ai_interval` (AI 深度决策间隔)
*   **建议**: 300s (5分钟)。系统会在非 AI 时间利用本地指标进行影子监控。

### `trailing_stop.callback_rate` (移动止盈回撤)
*   **"auto" 模式**: 核心亮点。系统通过 **ATR** 自动计算当前市场的噪音水平。波动大时放宽回撤，波动小时收紧，防止被震下车。

### `partial_tp_stages` (分段止盈阶梯)
*   **设计原理**: 确保在获得初步利润时已经收回部分成本，实现“零成本博弈”。
*   **内置规则**: 
    *   **5% 利润节点**: 减仓 30%。
    *   **10% 利润节点**: 再减仓 30% 并重置移动止盈基准线。
*   **自定义**: 目前该参数在 `position_manager.py` 中硬编码以确保核心风控稳定性。

### 🔄 仓位增减逻辑对比 (Scaling Logic)

为了确保账户安全，系统对“加仓”和“减仓”采取了完全不同的设计哲学：

| 维度 | 分批减仓 (Scaling Out) | 分批加仓 (Scaling In) |
| :--- | :--- | :--- |
| **核心目的** | **锁定利润**，落袋为安。 | **乘胜追击**，扩大战果。 |
| **触发机制** | **价格驱动**。触及设定的盈利百分比（如 5%, 10%）即自动执行。 | **信心驱动**。仅在 AI 给出 **HIGH** 信心信号时允许加仓。 |
| **自动化程度** | **高度自动**。由轨道 C (Orbit C) 实时监控并强制执行。 | **半自动/AI驱动**。需经过 AI 深度分析，且受“同向持仓保护”拦截。 |
| **风险控制** | 降低曝险，越涨卖得越多。 | 严控风险，禁止在震荡市或信心不足时补仓。 |

> **注意**: 系统**禁止**任何形式的“亏损补仓”（马丁格尔策略）。加仓必须建立在 AI 判定趋势极度明确（HIGH 信心）的基础之上。

---

## 3. 风险控制模块 (risk_control)

### `initial_balance_usdt` (零点校准基准)
*   **极其重要**: 如果你账户有 1000U 但只想用 15U 跑，请设为 `15.0`。
*   **Session PnL**: 系统以此计算真实投资回报率。

### `max_loss_usdt` (最大绝对亏损保护)
*   **机制**: 当日亏损超过此金额（如 10U）时，系统将触发**全局熔断**，停止所有交易。

### `max_drawdown_per_trade` (单笔最大亏损硬止损)
*   **[v3.9.7 新增]**: 这是针对单笔交易的“最后一道防线”。
*   **设计原理**: 无论 AI 给出的止损位在哪里，系统都会根据此比例强制设定一个硬止损。
*   **逻辑**: `硬止损价格 = 入场价 * (1 ± 最大亏损比例 / 杠杆)`。
*   **意义**: 防止因 AI 止损建议过宽或极端行情下的穿仓风险。例如设为 `0.1` (10%)，在 10x 杠杆下，单笔本金亏损达到 10% 时将强制平仓。
*   **建议**: 0.05 - 0.15 (5% - 15%)。

---

## 4. 15U 小资金实战配置建议 (Symbols)

针对 **15U** 初始资金，开启 4 个币种（BTC, ETH, PEPE, DOGE）时的配置艺术：

### `allocation` (资金分配比例)
*   **计算公式**: `每币种保证金 = initial_balance_usdt * allocation`。
*   **15U 方案**: 建议设为 `0.22`。
    *   `15U * 0.22 = 3.3U`。
    *   在 **10x 杠杆**下，持仓价值约为 **33U**。
    *   **门槛对齐**: OKX 的 BTC/ETH 最小下单通常为 10-20U，33U 的持仓规模可以完美触发下单。

### `leverage` (杠杆倍数)
*   **建议**: 10x。
*   **理由**: 小资金必须靠杠杆来跨越交易所的“最小下单门槛”。

### `trade_mode` (交易模式)
*   **建议**: `"cross"` (全仓)。
*   **理由**: 4 个币种共用 15U 保证金，容错率更高，防止单币种波动导致强平。

---

## 5. 常见错误码与排查

| 错误码 | 含义 | 排查方案 |
| :--- | :--- | :--- |
| **51008** | 余额不足 (Insufficient Margin) | 1. 检查 `allocation` 是否过高；2. 检查账户是否有其他手动挂单占用了资金。 |
| **429** | 频率超限 (Rate Limit) | v3.9.7 已内置限频器，若仍出现请调大 `loop_interval`。 |
| **51014** | 订单价值过小 | 增加 `allocation` 或提高 `leverage`。 |

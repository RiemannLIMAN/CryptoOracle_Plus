# 📘 OKXBot Plus (CryptoOracle) 项目说明书

> **版本**: v3.3.5 (Swing Trading Edition)
> **适用人群**: 量化交易初学者、Python 开发者、加密货币交易员
> **最后更新**: 2025-12-29
> **快速导航**: [环境搭建](#第三章环境搭建-保姆级教程) | [配置文件](#第四章配置文件详解) | [启动运行](#第五章启动与运行)

---

## 📖 目录

1. [第一章：项目介绍](#第一章项目介绍)
2. [第二章：技术选型与架构](#第二章技术选型与架构)
3. [第三章：环境搭建 (保姆级教程)](#第三章环境搭建-保姆级教程)
4. [第四章：配置文件详解](#第四章配置文件详解)
5. [第五章：启动与运行](#第五章启动与运行)
6. [第六章：核心资金与交易逻辑 (必读)](#第六章核心资金与交易逻辑-必读)
7. [第七章：常见问题与排错](#第七章常见问题与排错)

---

## 第一章：项目介绍

### 1.1 它是做什么的？
**OKXBot Plus** (代号 CryptoOracle) 是一个基于 **AI 大模型 (DeepSeek)** 的智能自动化交易机器人。它不仅仅是根据死板的指标（如 MACD 金叉）开单，而是像一个人类分析师一样，阅读 K 线形态、分析趋势强度、计算盈亏比，最后做出买卖决策。

### 1.2 核心亮点 (v3.3.5 更新)
*   **🧠 AI 大脑驱动**: 使用 DeepSeek-V3 模型，能够理解复杂的市场情绪和形态结构。
*   **📈 中线波段 (Swing Trading)**: 默认采用 **15m/1h** 周期，捕捉 5%~20% 的趋势行情，**拒绝高频刷单**，从根本上解决手续费磨损问题。
*   **💰 成本感知 (Cost Awareness)**: AI 在开单前会自动计算手续费和资金费率，严格遵守 **“预期利润 > 3倍成本”** 的原则。
*   **⚖️ 智能资金校准**: 启动时自动读取账户实际权益（含持仓），如果配置本金与实际偏差过大，会自动校准基准，确保盈亏统计 100% 真实。
*   **🛡️ 动态风控**: 针对 BTC/ETH 等主流币和 MEME/山寨币采用不同的止损策略（山寨币自动放宽止损以防插针）。

---

## 第二章：技术选型与架构

### 2.1 技术栈
*   **开发语言**: Python 3.8+ (简洁、强大的生态)
*   **交易所接口**: `ccxt` (支持 OKX V5 API，处理签名和网络请求)
*   **AI 接口**: `openai` (调用 DeepSeek 的 OpenAI 兼容接口)
*   **数据处理**: `pandas` (处理 K 线数据), `pandas_ta` (计算技术指标)
*   **异步框架**: `asyncio` (实现非阻塞的高并发交易)

### 2.2 目录结构
```text
OKXBot_Plus_Workspace/
├── config.json           # 核心配置文件 (账号、策略参数)
├── src/                  # 源代码目录
│   ├── OKXBot_Plus.py    # 程序入口 (启动文件)
│   ├── services/         # 业务逻辑层
│   │   ├── strategy/     # 策略层 (ai_strategy.py: AI分析逻辑)
│   │   ├── execution/    # 执行层 (trade_executor.py: 下单逻辑)
│   │   └── risk/         # 风控层 (risk_manager.py: 资金管理)
│   └── core/             # 核心工具 (utils.py, config.py)
├── log/                  # 运行日志 (crypto_oracle.log，自动清理旧日志)
├── png/                  # 资金曲线截图 (pnl_chart_xxxx.png)
└── doc/                  # 项目文档
```

---

## 第三章：环境搭建 (保姆级教程)

### 3.1 准备工作
1.  **操作系统**: Windows 10/11, macOS, 或 Linux (Ubuntu/CentOS)。
2.  **API Key**:
    *   **OKX**: 去欧易官网申请 V5 API Key (权限勾选：读取、交易)。**注意：请使用模拟盘先测试！**
    *   **DeepSeek**: 去 DeepSeek 开放平台申请 API Key。

### 3.2 安装 Python
下载并安装 [Python 3.10+](https://www.python.org/downloads/)。
*   **Windows 用户注意**: 安装时务必勾选 **"Add Python to PATH"**。

### 3.3 下载与安装依赖
1.  下载本项目代码到本地。
2.  在项目根目录打开终端 (CMD 或 PowerShell)。
3.  运行以下命令安装依赖库：
    ```bash
    pip install -r requirements.txt
    ```

---

## 第四章：配置文件详解

文件位置：`config.json` (首次使用请将 `config.example.json` 复制并重命名为 `config.json`)

```json
{
  "exchange": {
    "api_key": "你的OKX_API_KEY",
    "secret": "你的OKX_SECRET",
    "password": "你的OKX_PASSPHRASE",
    "use_sandbox": false  // true=模拟盘, false=实盘
  },
  "ai": {
    "provider": "deepseek",
    "api_key": "你的DeepSeek_API_KEY",
    "model": "deepseek-chat"
  },
  "trading": {
    "timeframe": "15m",     // [重要] K线周期，建议 15m 或 1h (中线波段)
    "leverage": 3,          // [重要] 杠杆倍数，建议 3x (配合中线宽止损)
    "risk_control": {
      "max_loss_usdt": 10.0,      // 单次最大止损金额 (U)
      "initial_balance_usdt": 0,  // 初始本金 (设为0则自动读取账户余额)
      "allocation": 0.9           // 仓位占比 (0.9 表示使用 90% 的资金)
    }
  },
  "symbols": [
    {
      "symbol": "BTC/USDT:USDT",  // 交易对 (合约需带 :USDT 后缀)
      "amount": "auto",           // 每次开仓数量 (auto=自动计算)
      "allocation": 0.5           // 该币种占用总资金的比例
    }
  ]
}
```

---

## 第五章：启动与运行

### 5.1 启动命令
在项目根目录终端运行：
```bash
# Windows
python src/OKXBot_Plus.py

# Mac/Linux
python3 src/OKXBot_Plus.py
```

### 5.2 运行界面说明
启动后，你会看到类似以下的日志：
1.  **Logo Banner**: 显示版本号 (v3.3.5)。
2.  **资产初始化盘点**: 表格显示当前账户的资金、持仓情况。
3.  **资金总数确认**: `💰 当前资金总数 (Total Equity): 100.00 U`。
    *   *注：如果此数值与您预期不符，请检查 OKX 账户余额。*
4.  **循环扫描**: 每隔 60秒，机器人会打印 `[SCAN] ...`，表示正在分析行情。

### 5.3 查看日志
*   **日志位置**: `log/crypto_oracle.log` (始终是这个文件，旧日志会自动清理)。
*   **查看命令**:
    ```bash
    tail -f log/crypto_oracle.log
    ```

---

## 第六章：核心资金与交易逻辑 (必读)

这是小白最容易晕的地方，请仔细阅读。

### 6.1 资金计算：智能基准 (Smart Baseline)
机器人如何判断你是赚了还是亏了？它使用 **"智能基准"** 机制。

*   **启动时自动校准**:
    *   机器人启动时，会读取账户里的 **实际总权益** (USDT余额 + 持仓价值)。
    *   如果 `config.json` 里写的本金是 100U，但实际账户只有 80U（比如之前亏了），机器人会自动把基准调整为 **80U**。
    *   这样做的目的是：**永远以“本次启动时的实际资金”为起点计算盈亏**，防止虚假的盈利显示。

*   **盈亏公式**:
    ```text
    当前盈亏 = 当前总资产 - 智能基准
    ```
    *   *日志示例*: `基准 80.00 U | 当前 85.00 U | 盈亏 +5.00 U (+6.25%)`

*   **实盘战绩对比**:
    *   日志中还会显示 `实盘战绩 (Realized PnL)`。这是直接从交易所拉取的“已平仓盈亏”数据。
    *   你可以对比“理论盈亏”和“实盘战绩”，两者应该非常接近。

### 6.2 交易决策：AI 如何思考？
1.  **数据收集**: 机器人获取最近 50 根 K 线数据，计算 MACD, RSI, 布林带等指标。
2.  **AI 分析**: 将数据打包发给 DeepSeek，问它：“基于 15m/1h 周期，现在是涨是跌？要不要操作？”
3.  **成本过滤 (Cost Awareness)**:
    *   AI 知道：开仓+平仓的手续费约为 **0.1%**。
    *   AI 原则：**“除非预期利润 > 0.3% (3倍成本)，否则不开单。”**
    *   这能有效过滤掉那些微小的波动（噪音），避免“赚的钱还不够交手续费”。

### 6.3 策略转型：为什么从短线改中线？
*   **旧版本 (Scalping)**: 做 1m/5m 超短线。
    *   *问题*: 容易被手续费磨损，且 AI 反应速度跟不上高频波动。
*   **新版本 (Swing Trading)**: 做 **15m/1h 中线波段**。
    *   *优势*: 捕捉 5%~20% 的大趋势。虽然开单频率低（可能一天就一两单），但胜率高，盈亏比极佳。
    *   *心态*: **耐心是金**。不要因为机器人几小时不动就焦虑，它在等待最佳时机。

---

## 第七章：常见问题与排错

**Q1: 机器人为什么一直 HOLD 不开单？**
A: 这通常是好事。说明 AI 认为当前行情不明朗，或者利润空间不足以覆盖手续费。请耐心等待趋势出现。

**Q2: 为什么日志里显示“资金校准失败”？**
A: 检查网络连接。可能是连接 OKX 超时导致无法获取余额。

**Q3: 怎么停止机器人？**
A: 在终端按 `Ctrl + C`。

**Q4: 我手动在 APP 里操作了，会影响机器人吗？**
A: 会。机器人会检测到余额变化。如果变化过大，它会尝试自动校准，但建议不要在机器人运行时手动干预同一交易对。

**Q5: 为什么生成的日志文件只有一个？以前不是很多吗？**
A: 为了保持目录整洁，v3.3.5 采用了单日志文件模式 (`crypto_oracle.log`)，并会自动清理 3 天前的旧日志。

---

**⚠️ 风险提示**: 加密货币市场波动极大，量化交易存在亏损风险。本项目仅供学习与辅助决策，作者不对任何交易损失负责。请务必使用模拟盘测试稳定后再实盘！
